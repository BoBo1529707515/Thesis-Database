## FIG2:
a.<img width="201" height="185" alt="image" src="https://github.com/user-attachments/assets/743b0326-3dbb-4d2d-bbbf-64dde84a1d65" />  
a.下丘脑内侧视前区(MPN)的微端镜钙成像   
b.<img width="305" height="225" alt="image" src="https://github.com/user-attachments/assets/b8ac1837-9272-4e0d-947a-b8eee9c329d5" />  
b.行为学与钙成像范式（paradigm）：先用时4周表达标记，随后做1-5天的社交隔离，在“重聚”前后以及移走同伴后持续成像。  
c1<img width="401" height="563" alt="image" src="https://github.com/user-attachments/assets/31db7c90-3c06-4765-8fb3-d8919672a6ff" />
c2<img width="334" height="549" alt="image" src="https://github.com/user-attachments/assets/7c6f9de6-56b5-497f-8a4c-f8acc9cd576a" />  
c:热图显示两类细胞镜像调制  
MPNIsolation：隔离时活跃；重聚时迅速被抑制；同伴移走后再被激活。  
MPNReunion：隔离时安静；重聚时被激活。  
说明：两类细胞分别跟踪“孤独/社交需要”与“社交互动”。
# 识别 MPN Isolation 与 Reunion 神经元：基于钙成像数据的分析流程

## 总体目标

本分析旨在通过比较神经元在特定行为事件（重聚）前后活动模式的变化，识别并分类出两类对重聚事件有显著响应的神经元：

*   **MPNIsolation 神经元**：在**重聚前（隔离期）活动高**，**重聚后活动低**。
*   **MPNReunion 神经元**：在**重聚前活动低**，**重聚后活动高**。

## 核心做法

以“重聚开始”为时间参考点（`t=0`）对齐所有神经元的活动时间序列。通过比较每个神经元在 `t<0`（基线/隔离期）与 `t>0`（重聚期）两个固定时间窗内的活动分布，利用 **ROC-AUC** 作为区分指标，并结合**置换检验**评估统计显著性。最终将达标的神经元分为两类，并通过热图和平均曲线进行可视化展示。1

---

## 详细步骤

### 1. 数据与预处理 (单细胞钙成像，头载显微镜)

1.  **运动校正与细胞分割**：
    *   使用如 **NoRMCorre** 进行运动校正。
    *   使用如 **CNMF-E** (Constrained Nonnegative Matrix Factorization for Endogenous signals) 进行细胞分割，提取每个神经元（ROI）的原始钙信号时间序列。
    *   从原始信号中提取去噪后的荧光变化 `dF/F` 或 `C` (去卷积后的钙浓度估计)。
2.  **去趋势/平滑**：
    *   对每个神经元的 `dF/F` 或 `C` 时间序列进行低幅度平滑处理，例如使用 1–3 秒的 **Gaussian 滤波器**，以去除高频噪声。
    *   可选：进一步去除极慢的信号漂移（如使用滑动平均或多项式拟合）。
3.  **归一化**：
    *   对每个神经元的时间序列进行 **z-score 归一化**（按时间维度），使其均值为 0，标准差为 1。这有助于在细胞间进行活动水平的比较和合并可视化。
    *   **色标设置**：可视化时，色标应以 `z=0` 为中心对称设置，避免单侧拉伸，以便清晰展示正向和负向活动变化。

### 2. 时间对齐与取窗

1.  **事件定义**：
    *   **`t=0`** 定义为“**重聚开始**”时刻。这通常对应于实验日志或行为标注中的特定事件，例如门/挡板移开，或实验动物首次接触的时刻。具体以实验记录为准。
2.  **时间窗口**：
    *   **Baseline/Isolation 窗**：`[-300 s, 0)`，用于代表重聚前的基线或隔离期活动。
    *   **Reunion 窗**：`[0, 300 s]`，用于代表重聚后的活动。
    *   **可视化窗**：为了更全面地展示活动趋势，热图的横轴通常会扩展到 `[-300 s, +600 s]` 或更宽。
3.  **采样与平滑**：
    *   将神经元活动痕迹重采样到 **1 Hz**，或对原始采样数据进行 **1 秒滑动平均**，以确保时间序列的均匀性和平滑性，便于后续统计分析和作图。

### 3. 每个神经元的分类 (核心判定)

对每个神经元，基于其在 `baseline` 窗和 `reunion` 窗内的 z-score 样本分布进行分类。

1.  **指标**：**ROC-AUC (Receiver Operating Characteristic - Area Under the Curve)**
    *   将 `baseline` 窗内的 z-score 值视为一个类别，`reunion` 窗内的 z-score 值视为另一个类别。
    *   **`AUC > 0.5`**：表明神经元活动**倾向于在 `reunion` 窗内更高**。
    *   **`AUC < 0.5`**：表明神经元活动**倾向于在 `baseline` 窗内更高**。
2.  **显著性检验**：**置换检验 (Permutation Test)**
    *   将 `baseline` 窗和 `reunion` 窗内的所有 z-score 样本合并，然后随机打乱并重新分配到两个“伪”窗中（保持原始窗的样本数量）。
    *   重复此过程 1000 次（或更多），计算每次置换的 AUC 值，构建一个置换分布。
    *   比较真实计算的 AUC 值与置换分布：如果真实 AUC 落在置换分布的 **95% 之外**（即 `p_shuffle < 0.05`），则认为该神经元的活动差异是显著的。
3.  **分类阈值与规则** (参考经典文献/代码)：
    *   **MPNReunion 神经元**：
        *   `AUC > 0.7` **且** `p_shuffle < 0.05`
    *   **MPNIsolation 神经元**：
        *   `AUC < 0.3` **且** `p_shuffle < 0.05`
    *   不满足上述条件的神经元标记为 `other`，不纳入 Fig. 2c 的两块热图展示。
    *   **备注**：对于 `MPNIsolation` 神经元，在可视化和排序时，有时会使用 `1 - AUC` 作为“隔离偏好度”指标（此时 `1 - AUC > 0.7`），以便与 `MPNReunion` 的 `AUC` 值在同一方向上表示“偏好度”；但统计显著性判断仍基于原始 `AUC < 0.3` 的左侧检验。

### 4. 热图与排序 (Fig. 2c 的上半部分)

1.  **展示方式**：
    *   分为两块热图，分别展示鉴定出的 `MPNIsolation` 神经元和 `MPNReunion` 神经元。
    *   横轴为相对时间（秒），纵轴为单个细胞（通常会合并多只动物的细胞）。
2.  **排序**：各块内部的神经元按照其对事件的响应强度进行排序。
    *   **MPNIsolation**：按 `baseline_mean - reunion_mean` 的值从大到小排序（即基线期活动高于重聚期活动的程度）。
    *   **MPNReunion**：按 `reunion_mean - baseline_mean` 的值从大到小排序（即重聚期活动高于基线期活动的程度）。
3.  **颜色与标注**：
    *   **颜色方案**：作者图例常用绿色系表示 `MPNIsolation` 偏好，紫色系表示 `MPNReunion` 偏好。色标应围绕 `z=0` 对称设置。
    *   **标注**：在 `t=0` 处画一条垂直虚线，强调重聚事件的发生时刻。在图例或标题中注明入选的神经元数量（例如，`MPNIsolation` 117/714，`MPNReunion` 137/714，具体数值随数据而变）。

### 5. 平均曲线 (Fig. 2c 的下半部分)

1.  **计算与绘制**：
    *   对每块热图对应的神经元集合，在每个时间点上计算其 `z-score` 的**细胞层面平均值**。
    *   将这些平均值绘制成折线图，作为热图下方的补充，展示该类别神经元的整体活动趋势。
2.  **可选要素**：
    *   添加阴影表示 **±SEM** (标准误，跨细胞计算)，反映群体活动的变异性。
    *   在 `t=0` 处画一条垂直虚线。
    *   横轴与热图共享时间轴；纵轴单位为“平均 z-score”。

### 6. 跨动物汇总与纳入标准

1.  **数据汇总**：
    *   将来自多只实验动物的合格细胞合并在一起进行统计和可视化。
    *   确保每只动物的实验条件（如“场次/天数”，例如 Day 3 重聚）是一致的。
    *   同一细胞仅计算一次。
2.  **细胞质量控制 (QC)**：
    *   在进入统计分析前，严格剔除低信噪比、受运动伪影严重干扰、或与血管/神经胶质细胞混淆的 ROI。
    *   进行去重处理，排除空间上高度重叠的重复识别的神经元。
3.  **缺失数据处理**：
    *   剔除在关键分析时间窗内（`[-300s, 300s]`）存在大量数据缺失的细胞或时间点。
    *   在必要时，可对极短的缺失数据段进行线性插值或使用前后值填补，但应避免跨越关键行为段进行插值。

---

## 为什么选择 ROC-AUC + 置换检验？

1.  **ROC-AUC 的优势**：
    *   **对尺度和分布的鲁棒性**：AUC 不依赖于数据的绝对幅值，对非高斯分布、多峰分布或存在异常值的时间序列数据具有很强的鲁棒性。这在行为学相关的神经活动分析中尤为重要，因为神经元的激活模式往往不是简单的正态分布。
    *   **直接衡量可分性**：AUC 直接量化了两个分布（这里是 `baseline` 窗和 `reunion` 窗的活动）之间的“可分性”或“重叠程度”。它能有效捕捉神经元活动从一个状态到另一个状态的转变趋势，而不仅仅是均值的差异。
    *   **非参数性**：作为一种非参数指标，它不对数据分布做任何假设，适用于各种复杂的神经活动模式。

2.  **置换检验的优势**：
    *   **对非正态和异方差的鲁棒性**：传统的参数检验（如 t 检验）通常假设数据服从正态分布且方差齐性。然而，神经元活动时间序列往往不满足这些假设。置换检验作为一种非参数方法，不依赖于这些假设，因此对时间序列的非正态性和异方差性更具鲁棒性。
    *   **控制假阳性风险**：通过随机打乱标签并重复计算，置换检验能够构建一个经验性的零分布，从而准确评估观察到的效应（真实 AUC 值）在随机波动下出现的概率。这有效地控制了“仅仅因为随机波动”而被误判为显著的风险，提高了结果的可靠性。
    *   **适用于复杂统计量**：置换检验可以用于任何统计量（包括 AUC），而无需推导其理论分布，使其成为评估复杂效应显著性的强大工具。

---
